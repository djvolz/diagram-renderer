name: Visual Regression Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'diagram_renderer/**'
      - 'examples/**'
      - 'tests/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'diagram_renderer/**'
      - 'examples/**'
      - 'tests/**'

jobs:
  visual-regression:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v3

    - name: Install dependencies with visual testing support
      run: |
        uv sync --extra dev
        uv pip install pillow numpy playwright

    - name: Install Playwright browsers
      run: |
        uv run playwright install chromium

    - name: Check for baseline images
      id: check-baselines
      run: |
        if [ -d "tests/visual/baselines" ] && [ "$(find tests/visual/baselines -name '*.png' | wc -l)" -gt 0 ]; then
          echo "baselines_exist=true" >> $GITHUB_OUTPUT
          echo "Found $(find tests/visual/baselines -name '*.png' | wc -l) baseline images"
        else
          echo "baselines_exist=false" >> $GITHUB_OUTPUT
          echo "No baseline images found"
        fi

    - name: Generate baseline images (if none exist)
      if: steps.check-baselines.outputs.baselines_exist == 'false'
      run: |
        echo "🎯 Generating baseline images (first time setup)"
        uv run python tests/visual/baseline_generator.py

        # For now, just generate baselines without committing
        # TODO: Implement proper baseline management strategy
        echo "✅ Generated baseline images for testing"

    - name: Run visual regression tests
      # Always run tests, whether baselines existed or were just generated
      run: |
        echo "🔍 Running visual regression tests..."
        if [ -d "tests/visual/baselines" ] && [ "$(find tests/visual/baselines -name '*.png' | wc -l)" -gt 0 ]; then
          uv run python tests/visual/visual_test_runner.py --threshold 0.95
        else
          echo "⚠️ No baseline images found, skipping visual tests"
          echo "To generate baselines: python tests/visual/baseline_generator.py"
        fi

    - name: Upload visual diff artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: visual-regression-diffs
        path: tests/visual/artifacts/
        retention-days: 30

    # Note: PR comment action removed due to permission issues
    # Visual test results can be seen in the job output and artifacts
